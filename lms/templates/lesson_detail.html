{% extends 'base.html' %}
{% block content %}
<h1>{{ lesson.title }}</h1>
<p>{{ lesson.content }}</p>

{% if user.is_authenticated and user.student_profile %}
<h3>Сдача домашнего задания:</h3>
{% if submission %}
<p><strong>Ваше задание:</strong> {{ submission.content }}</p>
{% if submission.files.all %}
  <div class="mb-2">
    <strong>Вложенные файлы:</strong>
    <div class="file-previews mt-2">
      {% for f in submission.files.all %}
        {% with url=f.file.url|lower %}
          {% if url|slice:"-4:" == ".jpg" or url|slice:"-5:" == ".jpeg" or url|slice:"-4:" == ".png" or url|slice:"-4:" == ".gif" %}
            <a href="{{ f.file.url }}" target="_blank"><img src="{{ f.file.url }}" class="img-thumbnail me-2 mb-2" style="max-width:120px; max-height:90px;"></a>
          {% else %}
            <div class="d-inline-block me-3 mb-2"><a href="{{ f.file.url }}" target="_blank">{{ f.file.name }}</a></div>
          {% endif %}
          {% if submission.student.user == user %}
            <form method="post" action="{% url 'submission_file_delete' f.id %}" class="d-inline ms-2">
              {% csrf_token %}
              <button type="submit" class="btn btn-sm btn-outline-danger">Удалить</button>
            </form>
          {% endif %}
        {% endwith %}
      {% endfor %}
    </div>
  </div>
{% endif %}
<p><strong>Оценка:</strong> {% if submission.is_graded %}{{ submission.grade }}{% else %}Не оценено{% endif %}</p>
{% if submission and submission.student.user == user %}
    <form method="post" action="{% url 'submission_delete' submission.id %}" class="d-inline">
        {% csrf_token %}
        <button type="submit" class="btn btn-sm btn-danger">Удалить отправку</button>
    </form>
{% endif %}
{% endif %}

<form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    {{ form.as_p }}
    <div class="mb-2">
      <label class="form-label">Прикрепить файлы</label>
      <input type="file" name="attachments" class="form-control form-control-sm" multiple>
    </div>
    <button type="submit" class="btn btn-primary">Отправить</button>
</form>
{% endif %}

{% if user == lesson.course.teacher %}
<h3>Домашние задания студентов:</h3>
<ul class="list-group">
    {% for hw in lesson.submissions.all %}
    <li class="list-group-item d-flex justify-content-between align-items-center">
        <div>
          {{ hw.student.user.get_full_name|default:hw.student.user.username }}
          {% if hw.files.all %}
            <div class="small text-muted">Файлы: 
              {% for f in hw.files.all %}
                <a href="{{ f.file.url }}" target="_blank">{{ f.file.name }}</a>{% if not forloop.last %}, {% endif %}
              {% endfor %}
            </div>
          {% endif %}
        </div>
        <div>
          <a href="{% url 'grade_submission' hw.id %}" class="btn btn-sm btn-success">Оценить</a>
        </div>
    </li>
    {% empty %}
    <p>Заданий пока нет.</p>
    {% endfor %}
</ul>
{% endif %}

<h3>Дедлайны урока:</h3>
{% if lesson_deadlines %}
<ul class="list-group mb-3">
    {% for dl in lesson_deadlines %}
    <li class="list-group-item d-flex justify-content-between align-items-center">
        <div>
            <strong>{{ dl.title }}</strong>
            <div class="small text-muted">До: {{ dl.due_at|date:'SHORT_DATETIME_FORMAT' }}</div>
            <div class="small">{{ dl.description }}</div>
        </div>
        {% if user.is_staff %}
        <div>
            <a href="{% url 'deadline_edit' dl.id %}" class="btn btn-sm btn-secondary">Изменить</a>
            <a href="{% url 'deadline_delete' dl.id %}" class="btn btn-sm btn-danger">Удалить</a>
        </div>
        {% endif %}
    </li>
    {% endfor %}
</ul>
{% else %}
<p>Дедлайнов пока нет.</p>
{% endif %}

{% if user.is_staff %}
<a href="{% url 'deadline_create' lesson.id %}" class="btn btn-sm btn-primary">Добавить дедлайн</a>

<h4 class="mt-3">Материалы урока</h4>
{% if lesson.attachments.all %}
  <ul class="list-unstyled">
    {% for f in lesson.attachments.all %}
      <li>
        <a href="{{ f.file.url }}" target="_blank">{{ f.file.name }}</a>
        <div class="small text-muted">Загружено {{ f.uploaded_at|date:'SHORT_DATETIME_FORMAT' }}{% if f.uploaded_by %} пользователем {{ f.uploaded_by.username }}{% endif %}</div>
        <form method="post" action="{% url 'lesson_attachment_delete' f.id %}" class="d-inline">
          {% csrf_token %}
          <button type="submit" class="btn btn-sm btn-outline-danger mt-1">Удалить</button>
        </form>
      </li>
    {% endfor %}
  </ul>
{% else %}
  <p class="text-muted">Материалов нет.</p>
{% endif %}

<form method="post" action="{% url 'lesson_add_attachment' lesson.id %}" enctype="multipart/form-data" class="mt-3">
  {% csrf_token %}
  <div class="mb-2">
    <label class="form-label">Добавить материалы (файлы)</label>
    <input type="file" name="attachments" class="form-control form-control-sm" multiple>
    <div class="file-previews mt-2"></div>
  </div>
  <button type="submit" class="btn btn-sm btn-secondary">Загрузить</button>
</form>
{% endif %}
{% endblock %}
