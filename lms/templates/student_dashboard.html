{% extends 'base.html' %}
{% block title %}Дашборд студента — MiniLMS{% endblock %}
{% block content %}
<h2>Мои курсы и задания</h2>

<h5>Ближайшие дедлайны</h5>
{% if deadlines and deadlines.count > 0 %}
  <ul class="list-group mb-3">
    {% for dl in deadlines %}
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <div>
          <strong>{{ dl.title }}</strong>
          <div class="small text-muted">До: {{ dl.due_at|date:'SHORT_DATETIME_FORMAT' }}</div>
          {% if dl.lesson %}
            <div class="small">Урок: <a href="{% url 'lesson_detail' dl.lesson.id %}">{{ dl.lesson.title }}</a></div>
          {% endif %}
        </div>
        {% if user.is_staff %}
          <div>
            <a href="{% url 'deadline_edit' dl.id %}" class="btn btn-sm btn-secondary">Изменить</a>
            <a href="{% url 'deadline_delete' dl.id %}" class="btn btn-sm btn-danger">Удалить</a>
          </div>
        {% endif %}
      </li>
    {% endfor %}
  </ul>
{% else %}
  <p class="text-muted">Ближайших дедлайнов нет.</p>
{% endif %}

{% if courses_data %}
  {% for entry in courses_data %}
    <div class="card mb-3">
      <div class="card-body">
        <h5 class="card-title">{{ entry.course.title }}</h5>
        <p class="card-text">{{ entry.course.description|truncatechars:200 }}</p>
        <h6>Занятия</h6>
        <ul class="list-group">
          {% for item in entry.lessons %}
            {% with lesson=item.lesson submission=item.submission %}
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                  <a href="{% url 'lesson_detail' lesson.id %}">{{ lesson.title }}</a>
                  {% if submission %}
                    <span class="badge bg-success ms-2">Отправлено</span>
                    {% if submission.is_graded %}
                      <span class="badge bg-info ms-2">Оценка: {{ submission.grade }}</span>
                    {% endif %}
                  {% else %}
                    <span class="badge bg-secondary ms-2">Не отправлено</span>
                  {% endif %}
                </div>
                <div>
                  <a class="btn btn-sm btn-outline-primary" href="{% url 'lesson_detail' lesson.id %}">Открыть</a>
                </div>
              </li>
            {% endwith %}
          {% endfor %}
        </ul>
      </div>
    </div>
  {% endfor %}
{% else %}
  <p>Вы не записаны ни на один курс.</p>
{% endif %}
{% endblock %}
